name: Cleanup untagged GHCR packages

on:
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      PACKAGE_OWNER: medium1992
      PACKAGE_NAME: mihomo-fakeip-ros
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: List untagged SHAs
        run: |
          echo "Fetching package versions..."
          packages_json=$(gh api -H "Accept: application/vnd.github+json" \
            /users/${PACKAGE_OWNER}/packages/container/${PACKAGE_NAME}/versions)

          echo "Checking for untagged SHAs..."
          untagged_shas=()
          for pkg_id in $(echo "$packages_json" | jq -r '.[].id'); do
              tags_count=$(echo "$packages_json" | jq -r ".[] | select(.id==$pkg_id) | .metadata.container.tags | length")
              if [[ "$tags_count" -eq 0 ]]; then
                  echo "Untagged SHA found: $pkg_id"
                  untagged_shas+=("$pkg_id")
              fi
          done

          if [ ${#untagged_shas[@]} -eq 0 ]; then
              echo "No untagged SHAs found."
          else
              echo "Total untagged SHAs: ${#untagged_shas[@]}"
              # Uncomment next lines to actually delete them
              # for sha in "${untagged_shas[@]}"; do
              #     echo "Deleting $sha..."
              #     gh api -X DELETE /users/${PACKAGE_OWNER}/packages/container/${PACKAGE_NAME}/versions/$sha
              # done
          fi
