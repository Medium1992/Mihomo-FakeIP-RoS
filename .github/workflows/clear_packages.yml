name: Cleanup untagged GHCR packages

on:
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      PACKAGE_OWNER: medium1992
      PACKAGE_NAME: mihomo-fakeip-ros
      DELETE_UNTAGGED: "false"  # ‚Üê –ø–æ–º–µ–Ω—è–π –Ω–∞ "true", —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: List and optionally delete GHCR versions
        run: |
          set -e

          echo "Fetching package versions for ${PACKAGE_OWNER}/${PACKAGE_NAME}..."
          packages_json=$(gh api -H "Accept: application/vnd.github+json" \
            /users/${PACKAGE_OWNER}/packages/container/${PACKAGE_NAME}/versions)

          total=$(echo "$packages_json" | jq length)
          echo "Total versions found: $total"
          echo ""

          echo "=== üè∑Ô∏è Tagged versions ==="
          tagged_ids=($(echo "$packages_json" | jq -r '.[] | select(.metadata.container.tags | length > 0) | .id'))
          if [ ${#tagged_ids[@]} -eq 0 ]; then
            echo "No tagged versions found."
          else
            for id in "${tagged_ids[@]}"; do
              data=$(gh api -H "Accept: application/vnd.github+json" \
                /users/${PACKAGE_OWNER}/packages/container/${PACKAGE_NAME}/versions/$id)
              digest=$(echo "$data" | jq -r '.name')
              tags=$(echo "$data" | jq -r '.metadata.container.tags | join(", ")')
              echo "- ID: $id | Digest: $digest | Tags: [$tags]"
            done
          fi

          echo ""
          echo "=== üß© Untagged versions ==="
          untagged_ids=($(echo "$packages_json" | jq -r '.[] | select(.metadata.container.tags | length == 0) | .id'))
          if [ ${#untagged_ids[@]} -eq 0 ]; then
            echo "‚úÖ No untagged SHAs found."
          else
            for id in "${untagged_ids[@]}"; do
              digest=$(gh api -H "Accept: application/vnd.github+json" \
                /users/${PACKAGE_OWNER}/packages/container/${PACKAGE_NAME}/versions/$id \
                | jq -r '.name')
              echo "- ID: $id | Digest: $digest"
            done

            if [[ "${DELETE_UNTAGGED}" == "true" ]]; then
              echo ""
              echo "‚ö†Ô∏è Deletion mode enabled ‚Äî deleting untagged versions..."
              for id in "${untagged_ids[@]}"; do
                echo "Deleting version ID: $id ..."
                gh api -X DELETE \
                  /users/${PACKAGE_OWNER}/packages/container/${PACKAGE_NAME}/versions/$id \
                  && echo "‚úÖ Deleted $id" \
                  || echo "‚ùå Failed to delete $id"
              done
            else
              echo ""
              echo "Dry-run mode (no deletions)."
              echo "Set DELETE_UNTAGGED=true in workflow to remove them."
            fi
          fi
